## Overview:
This repository contains the source file of llvm passes intended to be run on SYCL/OpenCL FPGA code.
The passes are developed out-of-tree, and intended to be loaded as a .so by the llvm _opt_ tool.
The driverLSQ.sh script demonstrates how the passes can be integrated into a compile cycle.

---

## Build:

**Pre-requisites:**
- CMake >=3.16 (devcloud has an older version, so need to install, e.g. using this CMake install [script](https://github.com/Kitware/CMake/releases/download/v3.26.0-rc5/cmake-3.26.0-rc5-linux-x86_64.sh). No sudo required, but remember to add it to the beginning of your path to override the system's cmake path.)
- ninja (https://github.com/ninja-build/ninja)
- Intel llvm sycl branch built from source
- Intel DPCPP compiler (2022.2 used). If you have apt: `sudo apt install intel-basekit`
- The basekit allows only emulation. If you want to run simulation, you can install the FPGA add-on for oneapi and the free Questa FPGA simulation software (https://www.intel.com/content/www/us/en/develop/documentation/oneapi-programming-guide/top/programming-interface/fpga-flow/evaluate-kernel-through-simulation/simulation-prerequisites.html). 
- To run in hardware, you can sign up to the Intel DevCloud to access Arria 10 and Stratix 10 FPGAs (https://www.intel.com/content/www/us/en/developer/tools/devcloud/overview.html)

**Build the intel llvm sycl branch from source:**
The dpcpp installation doesn't include the LLVM opt tool to run LLVM passes. So we need to build it from source. Once you install LLVM opt, make sure that the CMakeLists.txt LLVM version matches the installed one.
- `mkdir -p ~/git && cd ~/git` 
- `git clone https://github.com/intel/llvm.git && cd llvm` 
- `git checkout 40d08c238ce80e132df800ee21c3386f139fd85f` (To avoid LLVM version conflicts between dpcpp and this LLVM build, the commit time should come before your dpcpp --version. E.g. for dpcpp 2022.1.0.20220316 the intel/llvm sycl-branch commit should one that comes before 2022/03/16. The intel/llvm github repo has all dpcpp versions and git tags listed.)
- `python buildbot/configure.py --llvm-external-projects=clang-tools-extra && python buildbot/compile.py` 
- `cd build && ninja` (this will take several minutes)

**Build the passes in this repo:**
- `cd ~/git`
- `mkdir -p build && cd build`
- `export LT_LLVM_INSTALL_DIR=$HOME/git/llvm/build/` (best to add to your bash profile)
- `export LLVM_SYCL_PASSES_DIR=$HOME/git/llvm-sycl-passes` (best to add to your bash profile)
- `cmake ..`
- `make -j`

**Setup SYCL HLS compilation scripts:**
- Run `$LLVM_SYCL_PASSES_DIR/scripts/compilation/scripts/gen_compile_scripts.py`
- By defeault all targets are generated: --targets=emu,sim,hw (remove some if needed).
- By defeault a full hw and sim compile is NOT done. Rather, the linking commands are autogenerated based on previous commands from the dpcpp driver. If this fails, add the --slow flag to run a full compilation.
- *Explanation:* the dpcpp SYCL compiler driver consists of multiple other commands to build a host+device binary. To run the LLVM passes from this repo, we need to break up the driver into constituent commands such that we can compile transformed LLVM IR code into the final binary. The `genCompileScripts.py` runs the dpcpp driver in verbose mode and generates generic `compile_to_bc.sh` and `compile_from_bc.sh` scripts.

---

## Run transformations (LSQ or CDDD):

`driverLSQ.sh emu|sim|hw file [2|4|8|16|...] [-d]`

`driverCDDD.sh emu|sim|hw file [-d]`

- Ensure the LLVM_SYCL_PASSES_DIR environment vairable is set: `export LLVM_SYCL_PASSES_DIR=$HOME/git/llvm-sycl-passes` (change if required)
- The optional -d flag ensures that intermediate (LLVM IR, analysis reports) files are not deleted.
